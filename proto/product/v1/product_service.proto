syntax = "proto3";

package product.v1;

option go_package = "github.com/light-bringer/procat-service/proto/product/v1;productv1";

import "google/protobuf/timestamp.proto";

// ProductService provides operations for product catalog management.
service ProductService {
  // Commands (write operations)
  rpc CreateProduct(CreateProductRequest) returns (CreateProductReply);
  rpc UpdateProduct(UpdateProductRequest) returns (UpdateProductReply);
  rpc ActivateProduct(ActivateProductRequest) returns (ActivateProductReply);
  rpc DeactivateProduct(DeactivateProductRequest) returns (DeactivateProductReply);
  rpc ApplyDiscount(ApplyDiscountRequest) returns (ApplyDiscountReply);
  rpc RemoveDiscount(RemoveDiscountRequest) returns (RemoveDiscountReply);
  rpc ArchiveProduct(ArchiveProductRequest) returns (ArchiveProductReply);
  rpc UpdatePrice(UpdatePriceRequest) returns (UpdatePriceReply);

  // Queries (read operations)
  rpc GetProduct(GetProductRequest) returns (GetProductReply);
  rpc ListProducts(ListProductsRequest) returns (ListProductsReply);
  rpc ListEvents(ListEventsRequest) returns (ListEventsReply);
}

// Money represents a monetary value with precise decimal representation.
message Money {
  int64 numerator = 1;
  int64 denominator = 2;
}

// Product represents a product in the catalog.
message Product {
  string product_id = 1;
  string name = 2;
  string description = 3;
  string category = 4;
  double base_price = 5;
  double effective_price = 6;
  optional double discount_percent = 7; // Supports fractional values (e.g., 12.5 for 12.5%)
  bool discount_active = 8;
  string status = 9;
  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp updated_at = 11;
  optional google.protobuf.Timestamp archived_at = 12; // When product was archived (if archived)
}

// CreateProduct
message CreateProductRequest {
  string name = 1;
  string description = 2;
  string category = 3;
  Money base_price = 4;
}

message CreateProductReply {
  string product_id = 1;
}

// UpdateProduct
message UpdateProductRequest {
  string product_id = 1;
  optional int64 version = 2; // For optimistic locking (backwards compatible)
  optional string name = 3;
  optional string description = 4;
  optional string category = 5;
}

message UpdateProductReply {
  // Empty - success indicated by no error
}

// UpdatePrice
message UpdatePriceRequest {
  string product_id = 1;
  optional int64 version = 2; // For optimistic locking (backwards compatible)
  Money new_price = 3;
  string changed_by = 4;
  string changed_reason = 5;
}

message UpdatePriceReply {
  // Empty - success indicated by no error
}

// ActivateProduct
message ActivateProductRequest {
  string product_id = 1;
  optional int64 version = 2; // For optimistic locking (backwards compatible)
}

message ActivateProductReply {
  // Empty - success indicated by no error
}

// DeactivateProduct
message DeactivateProductRequest {
  string product_id = 1;
  optional int64 version = 2; // For optimistic locking (backwards compatible)
}

message DeactivateProductReply {
  // Empty - success indicated by no error
}

// ApplyDiscount
message ApplyDiscountRequest {
  string product_id = 1;
  optional int64 version = 2; // For optimistic locking (backwards compatible)
  double discount_percent = 3; // Supports fractional values (e.g., 12.5 for 12.5%)
  google.protobuf.Timestamp start_date = 4;
  google.protobuf.Timestamp end_date = 5;
}

message ApplyDiscountReply {
  // Empty - success indicated by no error
}

// RemoveDiscount
message RemoveDiscountRequest {
  string product_id = 1;
  optional int64 version = 2; // For optimistic locking (backwards compatible)
}

message RemoveDiscountReply {
  // Empty - success indicated by no error
}

// ArchiveProduct
message ArchiveProductRequest {
  string product_id = 1;
  optional int64 version = 2; // For optimistic locking (backwards compatible)
}

message ArchiveProductReply {
  google.protobuf.Timestamp archived_at = 1; // When the product was archived
}

// GetProduct
message GetProductRequest {
  string product_id = 1;
}

message GetProductReply {
  Product product = 1;
}

// ListProducts
message ListProductsRequest {
  string category = 1;
  string status = 2;
  int32 page_size = 3;
  string page_token = 4;
}

message ListProductsReply {
  repeated Product products = 1;
  string next_page_token = 2;
  int64 total_count = 3;
}

// Event represents a domain event from the outbox.
message Event {
  string event_id = 1;
  string event_type = 2;
  string aggregate_id = 3;
  string payload = 4;
  string status = 5;
  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp processed_at = 7;
}

// ListEvents
message ListEventsRequest {
  optional string event_type = 1; // Filter by event type (e.g., "product.created")
  optional string aggregate_id = 2; // Filter by aggregate ID
  optional string status = 3; // Filter by status ("pending", "processed", "failed")
  int32 limit = 4; // Max number of events to return (default: 100)
}

message ListEventsReply {
  repeated Event events = 1;
  int64 total_count = 2;
}
