version: '3.8'

services:
  spanner-test:
    image: gcr.io/cloud-spanner-emulator/emulator:latest
    ports:
      - "19010:9010"  # Different ports to avoid conflicts with dev
      - "19020:9020"
    environment:
      - SPANNER_EMULATOR_HOST=localhost:9010
    networks:
      - test-network

  # Migration service - runs once to set up database
  migrate-test:
    build:
      context: .
      dockerfile: Dockerfile.test
      target: test-base
    depends_on:
      spanner-test:
        condition: service_started
    environment:
      - SPANNER_EMULATOR_HOST=spanner-test:9010
      - SPANNER_PROJECT_ID=test-project
    volumes:
      - .:/app
    working_dir: /app
    command: >
      sh -c "
        echo 'Waiting for Spanner emulator...' &&
        sleep 5 &&
        echo 'Setting up test database...' &&
        go run cmd/migrate/main.go -instance=test-instance -database=product-catalog-test &&
        echo 'Database ready for tests!'
      "
    networks:
      - test-network

  # Unit tests runner (no DB needed)
  test-unit:
    build:
      context: .
      dockerfile: Dockerfile.test
      target: test-base
    volumes:
      - .:/app
      - go-cache:/go/pkg/mod
    working_dir: /app
    command: ["gotestsum", "--format", "testname", "--", "-race", "-count=1", "./internal/app/product/domain/..."]
    networks:
      - test-network

  # Integration tests runner (with Spanner)
  test-integration:
    build:
      context: .
      dockerfile: Dockerfile.test
      target: test-base
    depends_on:
      migrate-test:
        condition: service_completed_successfully
    environment:
      - SPANNER_EMULATOR_HOST=spanner-test:9010
      - SPANNER_PROJECT_ID=test-project
      - TEST_INSTANCE_ID=test-instance
      - TEST_DATABASE_ID=product-catalog-test
    volumes:
      - .:/app
      - go-cache:/go/pkg/mod
      - ./test-results:/app/test-results
    working_dir: /app
    command: >
      sh -c "
        echo 'Running integration tests with gotestsum...' &&
        mkdir -p test-results &&
        gotestsum --format testname --junitfile test-results/integration-junit.xml -- -race -count=1 -tags=integration ./tests/integration/...
      "
    networks:
      - test-network

  # E2E tests runner (full stack)
  test-e2e:
    build:
      context: .
      dockerfile: Dockerfile.test
      target: test-base
    depends_on:
      migrate-test:
        condition: service_completed_successfully
    environment:
      - SPANNER_EMULATOR_HOST=spanner-test:9010
      - SPANNER_PROJECT_ID=test-project
      - TEST_INSTANCE_ID=test-instance
      - TEST_DATABASE_ID=product-catalog-test
    volumes:
      - .:/app
      - go-cache:/go/pkg/mod
      - ./test-results:/app/test-results
    working_dir: /app
    command: >
      sh -c "
        echo 'Running E2E tests with gotestsum...' &&
        mkdir -p test-results &&
        gotestsum --format testname --junitfile test-results/e2e-junit.xml -- -race -count=1 -timeout=5m ./tests/e2e/...
      "
    networks:
      - test-network

  # All tests runner (comprehensive suite with gotestsum)
  test-all:
    build:
      context: .
      dockerfile: Dockerfile.test
      target: test-base
    depends_on:
      migrate-test:
        condition: service_completed_successfully
    environment:
      - SPANNER_EMULATOR_HOST=spanner-test:9010
      - SPANNER_PROJECT_ID=test-project
      - TEST_INSTANCE_ID=test-instance
      - TEST_DATABASE_ID=product-catalog-test
    volumes:
      - .:/app
      - go-cache:/go/pkg/mod
      - ./test-results:/app/test-results
    working_dir: /app
    command: >
      sh -c "
        mkdir -p test-results &&
        echo '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━' &&
        echo 'Product Catalog Service - Test Suite' &&
        echo '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━' &&
        echo '' &&
        echo '1. Running Unit Tests...' &&
        gotestsum --format testname --junitfile test-results/unit-junit.xml -- -race -count=1 ./internal/app/product/domain/... &&
        echo '' &&
        echo '2. Running Integration Tests...' &&
        gotestsum --format testname --junitfile test-results/integration-junit.xml -- -race -count=1 -tags=integration ./tests/integration/... &&
        echo '' &&
        echo '3. Running E2E Tests...' &&
        gotestsum --format testname --junitfile test-results/e2e-junit.xml -- -race -count=1 -timeout=5m ./tests/e2e/... &&
        echo '' &&
        echo '4. Generating Coverage Report...' &&
        gotestsum --format testname -- -coverprofile=test-results/coverage.out -covermode=atomic ./... &&
        go tool cover -html=test-results/coverage.out -o test-results/coverage.html &&
        go tool cover -func=test-results/coverage.out | tail -1 &&
        echo '' &&
        echo '✓ All tests completed successfully!'
      "
    networks:
      - test-network

  # Coverage report generator
  test-coverage:
    build:
      context: .
      dockerfile: Dockerfile.test
      target: test-base
    depends_on:
      migrate-test:
        condition: service_completed_successfully
    environment:
      - SPANNER_EMULATOR_HOST=spanner-test:9010
      - SPANNER_PROJECT_ID=test-project
    volumes:
      - .:/app
      - go-cache:/go/pkg/mod
      - ./coverage-reports:/app/coverage-reports
    working_dir: /app
    command: >
      sh -c "
        go test -coverprofile=coverage-reports/coverage.out -covermode=atomic ./... &&
        go tool cover -html=coverage-reports/coverage.out -o coverage-reports/coverage.html &&
        go tool cover -func=coverage-reports/coverage.out
      "
    networks:
      - test-network

networks:
  test-network:
    driver: bridge

volumes:
  go-cache:
